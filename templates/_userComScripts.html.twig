{% set channel = sylius.channel %}

{% if null != channel.userComApiKey and null != channel.userComUrl%}
    {% set customer = sylius.customer|default(null) %}
    {% set genderMap =  constant('BitBag\\SyliusUserComPlugin\\Builder\\Payload\\CustomerPayloadBuilderInterface::GENDER_MAP')%}
    {% set active =  constant('BitBag\\SyliusUserComPlugin\\Builder\\Payload\\CustomerPayloadBuilderInterface::STATUS_USER')%}
    {% set visitor =  constant('BitBag\\SyliusUserComPlugin\\Builder\\Payload\\CustomerPayloadBuilderInterface::STATUS_VISITOR')%}

    <script data-cfasync="false">window.civchat = {
            apiKey: "{{ user_com_frontend_api_key }}",
            name: "{{ customer.name|default(null) }}",
            user_id: "{{ customer.email|default(null) }}",
            email: "{{ customer.email|default(null) }}",
            gender: {{ null != customer ? genderMap[customer.gender] : genderMap['u'] }},
            status: {{ null != customer ? active : visitor }},
            phone_number: "{{ customer.phone_number|default(null)}}",
        }

        {% set routes =  constant('BitBag\\SyliusUserComPlugin\\EventSubscriber\\CustomerProfileUpdatedSubscriberInterface::API_INTEGRATION_ROUTES')%}
     </script>
    <script data-cfasync="false" src={{ channel.userComUrl ~ "widget.js" }}>
        {% if null == sylius.customer and app.request.attributes.get('_route') in routes %}
            UE.resetAuth({'apiKey': {{ user_com_frontend_api_key}}})
        {% endif %}
    </script>
{% endif %}

<!-- Google tag (gtag.js), plugin provided by Spinbits -->
<script async src="https://www.googletagmanager.com/gtag/js?id={{ id }}{{ url_suffix|raw }}"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){window.dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', '{{ id }}');
    if (window.performance) {
        gtag('event', 'timing_complete', {
            'name': 'load',
            'value': Math.round(performance.now()),
            'event_category': 'JS Dependencies'
        });
    }
    {% if app.session is not null and app.session.started %}
        {% set events = app.session.bag('spinbits_ga4_events').all %}
        {% for event, content in events %}
            {% for c in content %}
                gtag("event", "{{ event }}", {{ c|raw }});
            {% endfor %}
        {% endfor %}
    {% endif %}
</script>
